<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>

    <meta name="viewport" content="width=device-width">
    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <link rel='stylesheet' href='index.css'>
    <script src="util.js"></script>

    <style>
        .item {
            display: grid;
            border-top: 1px solid #b7b7b7;
            justify-content: space-between;
        }

        #items {
            padding-bottom: 20px;
        }
    </style>

</head>
<body>
<a href="../y12-compsci-nea-inventory" class="link">
    Home
</a>
<p id="name"></p>
<div id="items"></div>
<form action="backend/add-item.php">
    <label>
        Add Item:
        <input name="info" placeholder="info">
    </label>
    <input type="submit">
    <input type="hidden" id="type-name" name="type">
</form>
</body>
</html>

<script>
	const queryString = window.location.search;
	const urlParams = new URLSearchParams(queryString);
	const type = urlParams.get('type');
	const itemsDIV = $('#items');

	document.title = type;

	$('#type-name').val(type);

	function deleteItem (id, info) {
		if (!confirm(`Are you sure you want to delete ${type} #${id} (${info})`))
			return;

		window.location.href =
            `https://josephcoppin.com/school/y12-compsci-nea-inventory/backend/delete-item.php?id=${id}&type=${type}`;
	}

	function loanItem (id, info) {
		const loanTo = prompt(`Who is ${type} #${id} (${info}) being loaned to?`);
		if (!loanTo) return;

		window.location.href =
			`https://josephcoppin.com/school/y12-compsci-nea-inventory/backend/loan-item.php?id=${id}&type=${type}&to=${loanTo}`;
    }

	function unloanItem (id, info) {
		if (!confirm(`Are you sure ${type} #${id} (${info}) has been brought back?`)) return;

		window.location.href =
			`https://josephcoppin.com/school/y12-compsci-nea-inventory/backend/unloan-item.php?id=${id}&type=${type}`;
	}

	function showItems (items) {
		if (items.length < 1) {
			itemsDIV.html(`No Items`);
			return;
        }
		itemsDIV.html(items.map(item => `

		    <div class="item">
		        <div style="grid-column: 1/1">
		            #${item.id}
                </div>
                <div style="grid-column: 2/2">
                    ${item.info}
                </div>
                <div style="grid-column: 3/3">
                    ${item.isLent==1 ?
                        `<div style="background: rgba(255,0,0,0.2)">
                            Loaned by ${item.lastLeantTo} ${unixTimeAgo(item.lentLast)} ago
                        </div>` :
                        `<div style="background: rgba(8,255,0,0.2)">
                            In Storage
                        </div>`}
                </div>
                <div style="grid-column: 4/4">
                    ${item.isLent==1 ? `
                        <button onclick="unloanItem(${item.id}, '${item.info}')"> UnLoan </button>
                    ` : `
                        <button onclick="loanItem(${item.id}, '${item.info}')"> Loan </button>
                    `}
                </div>
                <div style="grid-column: 5/5">
                    <button onclick="deleteItem(${item.id})"> Delete </button>
                </div>

		    </div>

		`).join(""));
    }

	fetch('./backend/get.php')
		.then(async t => await t.json())
        .then(inventory => {
			showItems(inventory.filter(item => item.type === type));
            $('#name').html(`
                <div style="font-size: 40px; text-align: center">
                    Manage '${type}'
                </div>
            `);
        });

</script>